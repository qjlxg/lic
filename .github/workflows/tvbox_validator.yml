name: 'ğŸ“º TVBox é…ç½®éªŒè¯ä¸åˆå¹¶'

on:
  # 1. å…è®¸æ‰‹åŠ¨è¿è¡Œå·¥ä½œæµ
  workflow_dispatch:
    inputs:
      reason:
        description: 'æ‰‹åŠ¨è¿è¡ŒåŸå› '
        required: false
        default: 'æ‰‹åŠ¨è§¦å‘ TVBox é…ç½®éªŒè¯ä¸åˆå¹¶ã€‚'
  
  # 2. è‡ªåŠ¨è¿è¡Œï¼šå½“ä»¥ä¸‹æ–‡ä»¶å˜åŠ¨å¹¶æ¨é€åˆ° main/master åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches:
      - main  # æ ¹æ®æ‚¨çš„é»˜è®¤åˆ†æ”¯è°ƒæ•´ï¼Œå¯èƒ½æ˜¯ master
      - master
    paths:
      - 'box/**.json'        # box ç›®å½•ä¸‹çš„ JSON æ–‡ä»¶å˜åŠ¨
      - 'check_and_merge.py' # è„šæœ¬æ–‡ä»¶å˜åŠ¨
      - '.github/workflows/tvbox_validator.yml' # å·¥ä½œæµæ–‡ä»¶å˜åŠ¨

# ç¡®ä¿åŒæ—¶åªæœ‰ä¸€ä¸ªä½œä¸šè¿è¡Œï¼Œé˜²æ­¢ git æäº¤å†²çª
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate_and_merge:
    # è®¾å®šè¿è¡Œç¯å¢ƒ
    runs-on: ubuntu-latest
    
    steps:
      # 1. ä½¿ç”¨ Shell å‘½ä»¤è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ· (UTC+8)
      - name: è®¾ç½®æ—¶åŒºä¸ºäºšæ´²/ä¸Šæµ· (Shanghai Timezone)
        run: |
          sudo timedatectl set-timezone Asia/Shanghai
          echo "TZ=Asia/Shanghai" >> $GITHUB_ENV # è®¾ç½®ç¯å¢ƒå˜é‡ä»¥å½±å“åç»­æ­¥éª¤
          
      # 2. æ£€å‡ºä»“åº“ä»£ç  (fetch-depth: 0 ä»¥è·å–å®Œæ•´å†å²ï¼Œç”¨äºåç»­æ¨é€)
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      # 3. è®¾ç½® Python ç¯å¢ƒ
      - name: è®¾ç½® Python 3.x
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      # 4. å®‰è£… Python ä¾èµ– (requests)
      - name: å®‰è£… requests åº“
        run: pip install requests
        
      # 5. æ‰§è¡ŒéªŒè¯å’Œåˆå¹¶è„šæœ¬
      - name: è¿è¡Œé…ç½®éªŒè¯ä¸åˆå¹¶è„šæœ¬
        run: python check_and_merge.py
        
      # 6. é…ç½® Git èº«ä»½
      - name: é…ç½® Git æäº¤è€…
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

      # 7. æäº¤å¹¶æ¨é€ç»“æœæ–‡ä»¶
      - name: æäº¤å¹¶æ¨é€åˆå¹¶åçš„é…ç½®
        run: |
          # æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f merged_tvbox_config.json ]; then
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°ç”Ÿæˆçš„ merged_tvbox_config.json æ–‡ä»¶ï¼Œè·³è¿‡æäº¤ã€‚"
            exit 1
          fi

          # æ·»åŠ ç”Ÿæˆçš„æ–‡ä»¶
          git add merged_tvbox_config.json
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…æ”¹åŠ¨ (å¦‚æœæ–‡ä»¶å†…å®¹æ²¡æœ‰å˜åŒ–ï¼Œåˆ™ä¸è¿›è¡Œæäº¤)
          if git diff --staged --exit-code; then
            echo "merged_tvbox_config.json æ–‡ä»¶å†…å®¹æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤ã€‚"
            exit 0
          else
            # ä½¿ç”¨ä¸Šæµ·æ—¶é—´ç”Ÿæˆæäº¤ä¿¡æ¯
            # ä½¿ç”¨ $TZ ç¯å¢ƒå˜é‡ç¡®ä¿æ—¶é—´æ­£ç¡®
            COMMIT_TIME=$(date '+%Y-%m-%d %H:%M:%S') 
            COMMIT_MESSAGE="ğŸ¤– è‡ªåŠ¨åˆå¹¶ä¸éªŒè¯ TVBox é…ç½® @ ${COMMIT_TIME} (Shanghai)"
            
            git commit -m "$COMMIT_MESSAGE"
            echo "æ­£åœ¨æäº¤å¹¶æ¨é€ changes..."
            # ä½¿ç”¨ token æ¨é€ï¼Œç¡®ä¿æƒé™
            git push
          fi
