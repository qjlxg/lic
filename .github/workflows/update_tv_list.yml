name: ğŸ“º Update TV List from URLs

on:
  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:

  # å½“ä»¥ä¸‹æ–‡ä»¶è·¯å¾„æœ‰å˜åŠ¨æ—¶ï¼Œè‡ªåŠ¨è§¦å‘å·¥ä½œæµ
  push:
    paths:
      - 'config/urls.txt'
      - 'scripts/update_list.py'
      - '.github/workflows/update_tv_list.yml'

jobs:
  update-list:
    runs-on: ubuntu-latest
    
    # è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ· (Asia/Shanghai)
    env:
      TZ: Asia/Shanghai

    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4
        with:
          # å¿…é¡»è·å–å®Œæ•´å†å²è®°å½•ï¼Œä»¥ä¾¿è¿›è¡Œåç»­çš„ Git æ¨é€
          fetch-depth: 0

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: ğŸ› ï¸ Install dependencies (requests for HTTP fetching)
        run: pip install requests

      - name: âš™ï¸ Run Update Script and Save Output
        # è„šæœ¬å°†è¯»å– urls.txtï¼Œä¸‹è½½å†…å®¹ï¼Œå»é‡ï¼Œå¹¶ä¿å­˜åˆ° output/tv_list.m3u å’Œ output/tv_list.txt
        run: |
          mkdir -p output
          python scripts/update_list.py

      - name: ğŸš€ Commit and Push changes
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜åŒ–ï¼Œå¦‚æœæœ‰ï¼Œåˆ™æäº¤å¹¶æ¨é€
        run: |
          git config user.name "GitHub Actions"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # å°è¯•æ·»åŠ æ‰€æœ‰ output ç›®å½•ä¸‹çš„æ–‡ä»¶
          git add output/tv_list.m3u output/tv_list.txt
          
          # æ£€æŸ¥æš‚å­˜åŒºæ˜¯å¦æœ‰ä»»ä½•å˜åŒ–ï¼ˆ--porcelain ç”¨äºæœºå™¨å¯è¯»çš„è¾“å‡ºï¼‰
          if git status --porcelain | grep 'output/'; then
            echo "Changes found in output directory. Committing and Pushing..."
            git commit -m "ğŸ¤– Auto-update TV list from URLs (Run ${{ github.run_number }})"
            
            # ã€Git ä¿®å¤ã€‘ï¼šåœ¨æ¨é€å‰å…ˆæ‹‰å–è¿œç¨‹çš„æœ€æ–°æ›´æ”¹ï¼Œé˜²æ­¢â€œrejected (fetch first)â€é”™è¯¯
            # ä½¿ç”¨ --rebase ä¿æŒæäº¤å†å²å¹²å‡€æ•´æ´
            git pull --rebase origin main
            
            # æ¨é€æœ¬åœ°çš„æäº¤
            git push
          else
            echo "No changes in output directory. Skipping commit."
          fi
